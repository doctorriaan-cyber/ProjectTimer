
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Timer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    /* Basic Reset & Setup */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'Roboto Mono', monospace;

      /* Dynamic Accent Colors - Default to Teal */
      --accent-color-primary: #14b8a6;
      --accent-color-light: #2dd4bf;
      --accent-color-dark: #0d9488;
      --accent-color-rgb: 20, 184, 166;

      --red-500: #ef4444;
      --red-600: #dc2626;

      /* Dark Theme (Default) */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --border: #334155;
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    #root {
      max-width: 500px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    .header {
      position: relative; /* For center positioning of color picker */
      display: flex;
      justify-content: space-between;
      align-items: flex-start; /* Align to top */
      padding: 0.5rem 0;
      margin-bottom: 1.5rem;
    }
    
    .header-controls-left {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .header-search {
        display: flex;
        gap: 0.5rem;
    }
    
    .header-controls-center {
        position: absolute;
        top: 0.5rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
    }

    .header-actions-row {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      align-items: center;
    }

    .icon-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    .icon-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .icon-button svg {
      width: 24px;
      height: 24px;
      fill: var(--text-primary);
    }
    
    .sort-by-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-right: 0.25rem;
    }
    
    .sort-button {
        background-color: transparent;
        border: 1px solid;
        padding: 0.5rem 0.8rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        color: var(--text-secondary);
        border-color: var(--border);
    }
    .sort-button:hover:not(:disabled) {
        border-color: var(--accent-color-light);
        color: var(--accent-color-light);
    }
    .sort-button.active {
        border-color: var(--accent-color-light);
        color: var(--accent-color-light);
        background-color: rgba(var(--accent-color-rgb), 0.1);
    }
    .sort-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .add-project-header-button, .search-header-button, .clear-search-button, .view-toggle-button {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border);
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 40px; /* Align height with save button */
        white-space: nowrap;
    }
    .add-project-header-button:hover, .search-header-button:hover, .clear-search-button:hover, .view-toggle-button:hover {
        border-color: var(--accent-color-light);
        color: var(--accent-color-light);
    }

    .clear-search-button {
        border-color: var(--red-500);
        color: var(--red-500);
    }
     .clear-search-button:hover {
        border-color: var(--red-600);
        color: var(--red-600);
        background-color: rgba(220, 38, 38, 0.1);
    }


    .save-button {
      background-color: var(--accent-color-primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      height: 40px; /* Align height */
    }
    .save-button:hover {
      background-color: var(--accent-color-dark);
    }
    .save-button.saved {
      background-color: var(--accent-color-dark);
    }


    /* Project List */
    .project-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .no-projects {
        text-align: center;
        margin-top: 4rem;
        color: var(--text-secondary);
    }


    .project-item {
      position: relative; /* For color picker positioning */
      border-radius: 12px;
      transition: background-color 0.3s ease, box-shadow 0.3s;
      overflow: hidden;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border);
    }

    .project-item-main {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      cursor: pointer;
      transition: padding 0.3s ease;
    }

    .project-content-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .project-controls-left {
        display: flex;
        align-items: center;
    }
    
    .project-creation-date {
      font-size: 0.8rem;
      width: 100%;
      margin-bottom: -0.25rem; /* Adjust space to project name */
      color: var(--text-secondary);
    }

    .project-name {
      font-weight: 500;
      font-size: 1.2rem;
      text-align: center;
      width: 100%;
      transition: text-align 0.3s ease, font-size 0.3s ease;
      /* Color is now set via inline style */
    }

    .project-notes {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      padding-top: 0.75rem;
      border-top: 1px solid;
      width: 100%;
      text-align: center;
      font-style: italic;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-secondary); 
      border-color: var(--border);
    }
    .project-item.expanded .project-notes {
      white-space: normal;
      overflow: visible;
    }


    .project-time {
      font-family: var(--font-mono);
      font-size: 1.8rem;
      font-weight: 500;
      margin: 0 0.5rem;
      color: var(--accent-color-light);
    }


    .project-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .project-item-main .delete-button, 
    .project-item-main .add-time-button,
    .project-item-main .play-pause-button {
      cursor: pointer;
    }

    .project-item-main .delete-button, 
    .project-item-main .add-time-button,
    .project-item-main .play-pause-button,
    .project-item-main .icon-button {
       z-index: 2; /* Ensure buttons are clickable over the main div */
    }

    .delete-button svg, .edit-button svg { 
      fill: var(--text-secondary);
      transition: fill 0.2s ease;
    }
    .delete-button:hover svg { fill: var(--red-500); }
    .edit-button:hover svg { fill: var(--accent-color-light); }

    .add-time-button svg { 
      fill: var(--text-secondary);
      transition: fill 0.2s ease;
    }
    .add-time-button:hover svg { fill: var(--accent-color-light); }

    .play-pause-button {
      background-color: var(--accent-color-primary);
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    .play-pause-button:hover {
      background-color: var(--accent-color-dark);
    }
    .play-pause-button svg {
      fill: white;
      width: 24px;
      height: 24px;
    }
    .play-pause-button.running {
      background-color: var(--red-500);
    }
    .play-pause-button.running:hover {
      background-color: var(--red-600);
    }

    /* Color Pickers */
    .project-color-picker {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        z-index: 5;
    }
    .global-color-picker {
        position: relative;
        width: 32px;
        height: 32px;
    }
    .color-picker-display {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid var(--border);
        cursor: pointer;
        transition: border-color 0.2s ease;
    }
    .project-color-picker:hover .color-picker-display,
    .global-color-picker:hover .color-picker-display {
        border-color: var(--accent-color-light);
    }
    .color-picker-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        border: none;
    }
    
    /* Compact View Styles */
    .project-item.is-compact-mode:not(.expanded) .project-item-main {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }
    .project-item.is-compact-mode:not(.expanded) .project-name {
        text-align: left;
        font-size: 1.1rem;
    }
    .project-item.is-compact-mode:not(.expanded) .project-creation-date,
    .project-item.is-compact-mode:not(.expanded) .project-content-row,
    .project-item.is-compact-mode:not(.expanded) .project-notes,
    .project-item.is-compact-mode:not(.expanded) .project-color-picker {
        display: none;
    }


    /* Expanded Details & Time Log */
    .project-item-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
      padding: 0 1rem;
    }
    .project-item.expanded .project-item-details {
      max-height: 500px; /* Adjust as needed */
      padding: 0 1rem 1rem 1rem;
      border-top: 1px solid;
      border-color: var(--border);
    }
    
    .time-log-container { margin-top: 1rem; }
    .time-log-container h4 {
        margin-bottom: 0.75rem;
        font-weight: 500;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .time-log-list {
      list-style: none;
      max-height: 250px;
      overflow-y: auto;
      padding-right: 0.5rem; /* For scrollbar */
    }

    .time-log-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.25rem;
      font-size: 0.9rem;
    }
    .time-log-item:not(:last-child) { 
        border-bottom: 1px solid;
        border-color: var(--border);
    }

    .log-info { flex-grow: 1; display: flex; align-items: center; gap: 1rem; }
    .log-details { display: flex; flex-direction: column; gap: 0.2rem; }
    .log-date { font-weight: 500; }
    .log-date.weekend-log { color: var(--accent-color-light); }

    .log-method { 
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .log-duration { font-family: var(--font-mono); font-weight: 500; }
    .log-actions { display: flex; align-items: center; }
    .log-actions .icon-button svg { width: 18px; height: 18px; }
    .log-actions .icon-button { padding: 0.3rem; }
    
    .no-logs-message { 
        font-size: 0.9rem; text-align: center; padding: 1rem 0;
        color: var(--text-secondary);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      padding: 1.5rem;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      background-color: var(--bg-secondary);
    }

    .modal-content h2 {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .confirm-message {
      margin-bottom: 1.5rem;
      text-align: center;
      line-height: 1.5;
      color: var(--text-secondary);
    }

    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .form-input, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid;
      font-size: 1rem;
      font-family: var(--font-sans);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-color: var(--bg-primary);
      border-color: var(--border);
      color: var(--text-primary);
    }
    .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent-color-primary);
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.2);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .search-type-selector {
        display: flex;
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    .search-type-button {
        flex: 1;
        padding: 0.75rem;
        background-color: transparent;
        border: none;
        color: var(--text-secondary);
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .search-type-button:not(:last-child) {
        border-right: 1px solid var(--border);
    }
    .search-type-button.active {
        background-color: var(--accent-color-primary);
        color: white;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .modal-button {
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .modal-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .modal-button.primary {
      background-color: var(--accent-color-primary);
      color: white;
    }
    .modal-button.primary:hover:not(:disabled) {
      background-color: var(--accent-color-dark);
    }
    .modal-button.danger {
      background-color: var(--red-500);
      color: white;
    }
    .modal-button.danger:hover {
      background-color: var(--red-600);
    }
    .modal-button.secondary {
      background-color: transparent;
      color: var(--text-secondary);
    }
    .modal-button.secondary:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
  </style>
  
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.3.1",
      "react-dom/client": "https://esm.sh/react-dom@18.3.1/client"
    }
  }
  </script>
  <!-- Babel for in-browser JSX transpilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useCallback, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';

    // --- TYPE DEFINITIONS ---
    interface TimeLogEntry {
      id: number;
      date: string; // ISO string
      method: 'timer' | 'manual';
      startTime?: string; // ISO string for timer
      endTime?: string; // ISO string for timer
      duration: number; // in seconds
      manualType?: 'duration' | 'range';
      manualRange?: { start: string, end: string };
    }

    interface Project {
      id: number;
      name: string;
      notes: string;
      createdAt: string; // ISO string
      timeSpent: number; // in seconds, for completed sessions
      isRunning: boolean;
      timerStartTime?: number; // timestamp
      logs: TimeLogEntry[];
      isExpanded: boolean;
      color: string;
    }

    // --- CONSTANTS ---
    const LOCAL_STORAGE_KEYS = {
      PROJECTS: 'project-timer-projects',
      ACCENT_COLOR: 'project-timer-accent-color',
    };

    // --- HELPER FUNCTIONS ---
    const formatTime = (totalSeconds) => {
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = Math.floor(totalSeconds % 60);
      return [hours, minutes, seconds]
        .map(val => val.toString().padStart(2, '0'))
        .join(':');
    };
    
    const formatCreationDate = (isoString) => {
      if (!isoString) return '';
      const date = new Date(isoString);
      return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatLogDate = (isoString) => {
      const date = new Date(isoString);
      return date.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatLogTime = (isoString) => {
      const date = new Date(isoString);
      return date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    };
    
    const formatDateForInput = (isoString) => {
      if (!isoString) return '';
      return isoString.split('T')[0]; // Gets YYYY-MM-DD
    };

    const lightenDarkenColor = (col, amt) => {
        let usePound = false;
        if (col[0] === "#") {
            col = col.slice(1);
            usePound = true;
        }
        const num = parseInt(col, 16);
        let r = (num >> 16) + amt;
        if (r > 255) r = 255;
        else if (r < 0) r = 0;
        let b = ((num >> 8) & 0x00FF) + amt;
        if (b > 255) b = 255;
        else if (b < 0) b = 0;
        let g = (num & 0x0000FF) + amt;
        if (g > 255) g = 255;
        else if (g < 0) g = 0;
        return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
    };
    
    const hexToRgb = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    };


    // --- SVG ICONS ---
    const PlusIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    );
    const PlayIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    );
    const PauseIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    );
    const TrashIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
    );
    const ClockPlusIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm1-13h-2v4H7v2h4v4h2v-4h4v-2h-4V7z"/></svg>
    );
    const PencilIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
    );


    // --- COMPONENTS ---

    const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
        return (
            <div className="modal-overlay" onClick={onCancel}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <h2>Confirm Action</h2>
                    <p className="confirm-message">{message}</p>
                    <div className="modal-actions">
                        <button type="button" className="modal-button secondary" onClick={onCancel}>Cancel</button>
                        <button type="button" className="modal-button danger" onClick={onConfirm}>Delete</button>
                    </div>
                </div>
            </div>
        );
    };

    const ProjectModal = ({ projectToEdit, onSave, onClose }) => {
        const [name, setName] = useState('');
        const [notes, setNotes] = useState('');
        
        const isEditing = projectToEdit !== null;

        useEffect(() => {
            if (isEditing) {
                setName(projectToEdit.name);
                setNotes(projectToEdit.notes);
            }
        }, [projectToEdit, isEditing]);

        const handleSubmit = (e) => {
            e.preventDefault();
            if (name.trim()) {
                onSave({
                    id: isEditing ? projectToEdit.id : null,
                    name: name.trim(),
                    notes: notes.trim(),
                });
            }
        };

        const modalTitle = isEditing ? 'Edit Project' : 'Add New Project';
        const submitButtonText = isEditing ? 'Save Changes' : 'Add Project';

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <h2>{modalTitle}</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label htmlFor="projectName">Project Name</label>
                            <input id="projectName" type="text" value={name} onChange={(e) => setName(e.target.value)} className="form-input" required autoFocus/>
                        </div>
                        <div className="form-group">
                            <label htmlFor="projectNotes">Notes (optional)</label>
                            <textarea id="projectNotes" value={notes} onChange={(e) => setNotes(e.target.value)} className="form-textarea"/>
                        </div>
                        <div className="modal-actions">
                            <button type="button" className="modal-button secondary" onClick={onClose}>Cancel</button>
                            <button type="submit" className="modal-button primary">{submitButtonText}</button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    const TimeEntryModal = ({ project, logToEdit, onSubmit, onClose }) => {
        const [entryDate, setEntryDate] = useState('');
        const [duration, setDuration] = useState(''); // hh:mm format
        const [startTime, setStartTime] = useState('');
        const [endTime, setEndTime] = useState('');

        useEffect(() => {
            if (logToEdit) {
                setEntryDate(formatDateForInput(logToEdit.date));
                if (logToEdit.manualType === 'range' && logToEdit.manualRange) {
                    setStartTime(logToEdit.manualRange.start);
                    setEndTime(logToEdit.manualRange.end);
                } else {
                    const hours = Math.floor(logToEdit.duration / 3600);
                    const minutes = Math.floor((logToEdit.duration % 3600) / 60);
                    setDuration(`${hours}:${minutes.toString().padStart(2, '0')}`);
                }
            } else {
                setEntryDate(formatDateForInput(new Date().toISOString()));
            }
        }, [logToEdit]);

        const handleDurationChange = (e) => {
            const value = e.target.value.replace(/[^0-9:]/g, '');
            setDuration(value);
            if (value) {
                setStartTime('');
                setEndTime('');
            }
        };

        const handleTimeChange = (e, type) => {
            if (type === 'start') setStartTime(e.target.value);
            else setEndTime(e.target.value);
            
            if (e.target.value || (type === 'start' && endTime) || (type === 'end' && startTime)) {
                setDuration('');
            }
        };

        const parseDurationToSeconds = (durationStr) => {
            if (!durationStr || !/^\d{1,}:\d{2}$/.test(durationStr)) return 0;
            const parts = durationStr.split(':');
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);

            if (isNaN(hours) || isNaN(minutes) || minutes >= 60 || minutes < 0 || hours < 0) {
                return 0;
            }
            return (hours * 3600) + (minutes * 60);
        };
        
        const handleSubmit = (e) => {
            e.preventDefault();
            
            const secondsFromDuration = parseDurationToSeconds(duration);
            if (secondsFromDuration > 0) {
                onSubmit({ seconds: secondsFromDuration, type: 'duration', date: entryDate });
                return;
            }

            if (startTime && endTime) {
                const start = new Date(`1970-01-01T${startTime}`);
                const end = new Date(`1970-01-01T${endTime}`);

                if (end <= start) {
                    alert("'To' time must be after 'From' time for a valid duration.");
                    return;
                }
                const secondsToAdd = (end.getTime() - start.getTime()) / 1000;
                onSubmit({ seconds: secondsToAdd, type: 'range', start: startTime, end: endTime, date: entryDate });
            }
        };

        const isFormValid = (parseDurationToSeconds(duration) > 0 || (startTime && endTime && startTime < endTime)) && entryDate;
        const modalTitle = logToEdit ? "Edit Time Entry" : `Add Time to "${project.name}"`;

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <h2>{modalTitle}</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label htmlFor="entryDate">Date</label>
                            <input
                                id="entryDate"
                                type="date"
                                value={entryDate}
                                onChange={(e) => setEntryDate(e.target.value)}
                                className="form-input"
                                required
                            />
                        </div>

                        <div className="form-group">
                            <label htmlFor="addDuration">Add Duration (hh:mm)</label>
                            <input 
                                id="addDuration" 
                                type="text" 
                                value={duration} 
                                onChange={handleDurationChange} 
                                className="form-input" 
                                placeholder="e.g., 3:45"
                            />
                        </div>

                        <p style={{textAlign: 'center', margin: '1rem 0', fontWeight: '500', color: 'var(--text-secondary)'}}>OR</p>

                        <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
                            <div className="form-group" style={{flex: 1}}>
                                <label htmlFor="startTime">From</label>
                                <input id="startTime" type="time" value={startTime} onChange={(e) => handleTimeChange(e, 'start')} className="form-input" />
                            </div>
                            <div className="form-group" style={{flex: 1}}>
                                <label htmlFor="endTime">To</label>
                                <input id="endTime" type="time" value={endTime} onChange={(e) => handleTimeChange(e, 'end')} className="form-input" />
                            </div>
                        </div>
                        
                        <div className="modal-actions">
                            <button type="button" className="modal-button secondary" onClick={onClose}>Cancel</button>
                            <button type="submit" className="modal-button primary" disabled={!isFormValid}>Save</button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    const SearchModal = ({ onSearch, onClose }) => {
        const [searchType, setSearchType] = useState('name'); // 'name' or 'date'
        const [nameQuery, setNameQuery] = useState('');
        const [startDate, setStartDate] = useState('');
        const [endDate, setEndDate] = useState('');

        const handleSubmit = (e) => {
            e.preventDefault();
            if (searchType === 'name' && nameQuery.trim()) {
                onSearch({ type: 'name', value: nameQuery.trim() });
            } else if (searchType === 'date' && startDate && endDate && startDate <= endDate) {
                onSearch({ type: 'date', value: { start: startDate, end: endDate } });
            }
        };

        const isSearchDisabled = 
            (searchType === 'name' && !nameQuery.trim()) || 
            (searchType === 'date' && (!startDate || !endDate || startDate > endDate));

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <h2>Search Projects</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="search-type-selector">
                            <button type="button" className={`search-type-button ${searchType === 'name' ? 'active' : ''}`} onClick={() => setSearchType('name')}>Name</button>
                            <button type="button" className={`search-type-button ${searchType === 'date' ? 'active' : ''}`} onClick={() => setSearchType('date')}>Date Range</button>
                        </div>
                        
                        {searchType === 'name' ? (
                            <div className="form-group">
                                <label htmlFor="searchName">Project Name</label>
                                <input id="searchName" type="text" value={nameQuery} onChange={(e) => setNameQuery(e.target.value)} className="form-input" autoFocus />
                            </div>
                        ) : (
                            <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
                                <div className="form-group" style={{flex: 1}}>
                                    <label htmlFor="startDate">From</label>
                                    <input id="startDate" type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="form-input" />
                                </div>
                                <div className="form-group" style={{flex: 1}}>
                                    <label htmlFor="endDate">To</label>
                                    <input id="endDate" type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="form-input" />
                                </div>
                            </div>
                        )}

                        <div className="modal-actions">
                            <button type="button" className="modal-button secondary" onClick={onClose}>Cancel</button>
                            <button type="submit" className="modal-button primary" disabled={isSearchDisabled}>Search</button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };
    
    const TimeLogItem = ({ log, onEdit, onDelete }) => {
        const date = new Date(log.date);
        const dayOfWeek = date.getDay(); // 0 for Sunday, 6 for Saturday
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        const getLogMethod = () => {
            if (log.method === 'timer' && log.startTime && log.endTime) {
                return `Timer: ${formatLogTime(log.startTime)} - ${formatLogTime(log.endTime)}`;
            }
            if (log.method === 'manual') {
                if (log.manualType === 'range' && log.manualRange) {
                    return `Manual entry: ${log.manualRange.start} - ${log.manualRange.end}`;
                }
                return `Manual entry at ${formatLogTime(log.date)}`;
            }
            return 'Log Entry';
        };

        return (
            <li className="time-log-item">
                <div className="log-info">
                    <div className="log-details">
                        <span className={`log-date ${isWeekend ? 'weekend-log' : ''}`}>{formatLogDate(log.date)}</span>
                        <span className="log-method">{getLogMethod()}</span>
                    </div>
                </div>
                <div className="log-duration">
                    {formatTime(log.duration)}
                </div>
                <div className="log-actions">
                    <button className="icon-button" onClick={(e) => { e.stopPropagation(); onEdit(log.id); }} aria-label="Edit log entry">
                        <PencilIcon />
                    </button>
                    <button className="icon-button delete-button" onClick={(e) => { e.stopPropagation(); onDelete(log.id); }} aria-label="Delete log entry">
                        <TrashIcon />
                    </button>
                </div>
            </li>
        );
    };

    const TimeLogList = ({ logs, onEditLog, onDeleteLog }) => {
        if (!logs || logs.length === 0) {
            return <p className="no-logs-message">No time entries have been logged for this project yet.</p>;
        }
        return (
            <div className="time-log-container">
                <h4>Time Log</h4>
                <ul className="time-log-list">
                    {logs.map(log => <TimeLogItem key={log.id} log={log} onEdit={onEditLog} onDelete={onDeleteLog} />)}
                </ul>
            </div>
        );
    };

    const ProjectItem = ({ project, isCompactView, onToggleTimer, onEditProject, onDeleteProject, onOpenAddTime, onToggleExpansion, onEditLog, onDeleteLog, onColorChange }) => {
        const [currentTime, setCurrentTime] = useState(Date.now());

        useEffect(() => {
            if (!project.isRunning) return;
            const timer = setInterval(() => setCurrentTime(Date.now()), 1000);
            return () => clearInterval(timer);
        }, [project.isRunning]);

        const elapsedTime = project.isRunning && project.timerStartTime
            ? Math.floor((currentTime - project.timerStartTime) / 1000)
            : 0;

        const displaySeconds = project.timeSpent + elapsedTime;

        return (
            <li className={`project-item ${isCompactView ? 'is-compact-mode' : ''} ${project.isExpanded ? 'expanded' : ''}`}>
                <div className="project-color-picker">
                    <div className="color-picker-display" style={{ backgroundColor: project.color }}></div>
                    <input 
                        type="color" 
                        className="color-picker-input" 
                        value={project.color}
                        onChange={(e) => {
                            e.stopPropagation();
                            onColorChange(project.id, e.target.value);
                        }}
                        onClick={(e) => e.stopPropagation()}
                        aria-label="Change project name color"
                    />
                </div>
                <div className="project-item-main" onClick={() => onToggleExpansion(project.id)}>
                    {project.createdAt && <div className="project-creation-date">{`Added: ${formatCreationDate(project.createdAt)}`}</div>}
                    <div className="project-name" style={{ color: project.color }}>{project.name}</div>
                    
                    <div className="project-content-row">
                        <div className="project-controls-left">
                            <button className="icon-button delete-button" onClick={(e) => { e.stopPropagation(); onDeleteProject(project.id); }} aria-label="Delete project">
                                <TrashIcon />
                            </button>
                            <button className="icon-button edit-button" onClick={(e) => { e.stopPropagation(); onEditProject(project.id); }} aria-label="Edit project">
                                <PencilIcon />
                            </button>
                        </div>
                        
                        <div className="project-time">{formatTime(displaySeconds)}</div>

                        <div className="project-actions">
                            <button className={`play-pause-button ${project.isRunning ? 'running' : ''}`} onClick={(e) => { e.stopPropagation(); onToggleTimer(project.id); }} aria-label={project.isRunning ? 'Pause timer' : 'Start timer'}>
                                {project.isRunning ? <PauseIcon /> : <PlayIcon />}
                            </button>
                            <button className="icon-button add-time-button" onClick={(e) => { e.stopPropagation(); onOpenAddTime(project.id); }} aria-label="Add time worked">
                                <ClockPlusIcon />
                            </button>
                        </div>
                    </div>

                    {project.notes && <div className="project-notes">{project.notes}</div>}
                </div>
                <div className="project-item-details">
                    <TimeLogList 
                        logs={project.logs} 
                        onEditLog={(logId) => onEditLog(project.id, logId)}
                        onDeleteLog={(logId) => onDeleteLog(project.id, logId)}
                    />
                </div>
            </li>
        );
    };

    const App = () => {
        const [projects, setProjects] = useState([]);
        const [isLoaded, setIsLoaded] = useState(false);
        const [sortOrder, setSortOrder] = useState('lastAdded'); // 'lastAdded' or 'lastInteraction'
        
        // UI State
        const [isCompactView, setIsCompactView] = useState(false);
        const [accentColor, setAccentColor] = useState('#14b8a6');
        
        // Search
        const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);
        const [searchFilter, setSearchFilter] = useState(null); // { type: 'name' | 'date', value: any }

        // Project Modals
        const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
        const [projectToEdit, setProjectToEdit] = useState(null);
        const [isConfirmDeleteModalOpen, setIsConfirmDeleteModalOpen] = useState(false);
        const [projectToDelete, setProjectToDelete] = useState(null);
        
        // Time Entry Modals
        const [isTimeEntryModalOpen, setIsTimeEntryModalOpen] = useState(false);
        const [projectForTimeEntry, setProjectForTimeEntry] = useState(null);
        const [logToEdit, setLogToEdit] = useState(null); // { projectId, logId }
        const [isConfirmLogDeleteModalOpen, setIsConfirmLogDeleteModalOpen] = useState(false);
        const [logToDelete, setLogToDelete] = useState(null); // { projectId, logId }

        const [saveState, setSaveState] = useState('idle');
        
        // Load from localStorage on initial render
        useEffect(() => {
            try {
                // Load Accent Color
                const savedColor = localStorage.getItem(LOCAL_STORAGE_KEYS.ACCENT_COLOR);
                if (savedColor) {
                    setAccentColor(savedColor);
                }

                // Load Projects
                const savedProjects = localStorage.getItem(LOCAL_STORAGE_KEYS.PROJECTS);
                if (savedProjects) {
                    const parsedProjects = JSON.parse(savedProjects);
                    // Add new fields for backward compatibility
                    const projectsWithDefaults = parsedProjects.map(p => ({
                        notes: '',
                        ...p,
                        createdAt: p.createdAt || new Date(p.id).toISOString(),
                        isExpanded: p.isExpanded || false,
                        logs: p.logs || [],
                        color: p.color || '#f8fafc',
                    }));
                    // Sort initially by creation date
                    const sortedInitialProjects = projectsWithDefaults.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                    setProjects(sortedInitialProjects);
                }
            } catch (error) {
                console.error("Failed to load from localStorage", error);
            }
            setIsLoaded(true);
        }, []);

        // Update CSS variables and save accent color when it changes
        useEffect(() => {
            if (!isLoaded) return;
            try {
                const root = document.documentElement;
                const light = lightenDarkenColor(accentColor, 40);
                const dark = lightenDarkenColor(accentColor, -20);
                const rgb = hexToRgb(accentColor);

                root.style.setProperty('--accent-color-primary', accentColor);
                root.style.setProperty('--accent-color-light', light);
                root.style.setProperty('--accent-color-dark', dark);
                if (rgb) {
                    root.style.setProperty('--accent-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
                }
                
                localStorage.setItem(LOCAL_STORAGE_KEYS.ACCENT_COLOR, accentColor);
            } catch (error) {
                console.error("Failed to set accent color", error);
            }
        }, [accentColor, isLoaded]);

        // Auto-save projects to localStorage
        useEffect(() => {
            if (!isLoaded) return;
            try {
                // Persist the current state without altering it (e.g., stopping timers)
                localStorage.setItem(LOCAL_STORAGE_KEYS.PROJECTS, JSON.stringify(projects));
            } catch (error)
 {
                console.error("Failed to auto-save to localStorage", error);
            }
        }, [projects, isLoaded]);
        
        const handleSave = useCallback(() => {
            try {
                const now = Date.now();
                const projectsToSave = projects.map(p => {
                    if (!p.isRunning) {
                        return { ...p, isExpanded: false };
                    }
                    const duration = (now - p.timerStartTime) / 1000;
                    const newLog = {
                        id: now,
                        date: new Date(now).toISOString(),
                        method: 'timer',
                        startTime: new Date(p.timerStartTime).toISOString(),
                        endTime: new Date(now).toISOString(),
                        duration: Math.round(duration),
                    };
                    return {
                        ...p,
                        isRunning: false,
                        timerStartTime: undefined,
                        timeSpent: p.timeSpent + Math.round(duration),
                        logs: [newLog, ...(p.logs || [])],
                        isExpanded: false,
                    };
                });

                localStorage.setItem(LOCAL_STORAGE_KEYS.PROJECTS, JSON.stringify(projectsToSave));
                setProjects(projectsToSave);
                setSaveState('saved');
                setTimeout(() => setSaveState('idle'), 1500);
            } catch (error) {
                console.error("Failed to save to localStorage", error);
                alert("Could not save data. Your browser's storage might be full.");
            }
        }, [projects]);
        
        const handleSaveProject = ({ id, name, notes }) => {
            if (id) { // Editing existing project
                setProjects(prev => prev.map(p => 
                    p.id === id ? { ...p, name, notes } : p
                ));
            } else { // Adding new project
                const newProject = {
                    id: Date.now(),
                    name,
                    notes,
                    createdAt: new Date().toISOString(),
                    timeSpent: 0,
                    isRunning: false,
                    logs: [],
                    isExpanded: false,
                    color: '#f8fafc',
                };
                setProjects(prev => [newProject, ...prev]);
                setSortOrder('lastAdded');
            }
            handleCloseProjectModal();
        };

        const handleOpenAddProjectModal = () => {
            setProjectToEdit(null);
            setIsProjectModalOpen(true);
        };
        
        const handleOpenEditProjectModal = (id) => {
            const project = projects.find(p => p.id === id);
            if (project) {
                setProjectToEdit(project);
                setIsProjectModalOpen(true);
            }
        };

        const handleCloseProjectModal = () => {
            setIsProjectModalOpen(false);
            // Delay clearing to prevent content disappearing during animation
            setTimeout(() => setProjectToEdit(null), 300); 
        };
        
        const handleDeleteRequest = (id) => {
            setProjectToDelete(id);
            setIsConfirmDeleteModalOpen(true);
        };

        const handleConfirmDelete = () => {
            if (projectToDelete !== null) {
                setProjects(prev => prev.filter(p => p.id !== projectToDelete));
            }
            setProjectToDelete(null);
            setIsConfirmDeleteModalOpen(false);
        };

        const handleCancelDelete = () => {
            setProjectToDelete(null);
            setIsConfirmDeleteModalOpen(false);
        };
        
        const handleToggleTimer = (id) => {
            const now = Date.now();
            setProjects(projects.map(p => {
                if (p.id !== id) return p;

                if (p.isRunning) { // PAUSING
                    const duration = (now - p.timerStartTime) / 1000;
                    const newLog = {
                        id: now,
                        date: new Date().toISOString(),
                        method: 'timer',
                        startTime: new Date(p.timerStartTime).toISOString(),
                        endTime: new Date(now).toISOString(),
                        duration: Math.round(duration),
                    };
                    return {
                        ...p,
                        isRunning: false,
                        timerStartTime: undefined,
                        timeSpent: p.timeSpent + Math.round(duration),
                        logs: [newLog, ...(p.logs || [])].sort((a,b) => new Date(b.date) - new Date(a.date)),
                    };
                } else { // STARTING
                    return { ...p, isRunning: true, timerStartTime: now };
                }
            }));
        };
        
        const handleOpenAddTimeModal = (projectId) => {
            setProjectForTimeEntry(projectId);
            setIsTimeEntryModalOpen(true);
        };
        
        const handleOpenEditLogModal = (projectId, logId) => {
            setProjectForTimeEntry(projectId);
            setLogToEdit({ projectId, logId });
            setIsTimeEntryModalOpen(true);
        };

        const handleCloseTimeEntryModal = () => {
            setIsTimeEntryModalOpen(false);
            setTimeout(() => {
                setProjectForTimeEntry(null);
                setLogToEdit(null);
            }, 300);
        };
        
        const handleSaveTimeEntry = (details) => {
            if (!details || details.seconds <= 0 || !details.date) return;

            if (logToEdit) { // --- EDITING LOG ---
                setProjects(prev => prev.map(p => {
                    if (p.id !== logToEdit.projectId) return p;

                    const oldLog = p.logs.find(l => l.id === logToEdit.logId);
                    if (!oldLog) return p;

                    const timeDifference = Math.round(details.seconds) - oldLog.duration;
                    
                    const originalTime = new Date(oldLog.date).toTimeString().split(' ')[0]; // HH:mm:ss
                    const newIsoDate = new Date(`${details.date}T${originalTime}`).toISOString();
                    
                    const updatedLog = {
                        ...oldLog,
                        date: newIsoDate,
                        duration: Math.round(details.seconds),
                        method: 'manual',
                        manualType: details.type,
                        manualRange: details.type === 'range' ? { start: details.start, end: details.end } : undefined,
                        startTime: undefined,
                        endTime: undefined,
                    };
                    
                    const updatedLogs = p.logs.map(l => l.id === logToEdit.logId ? updatedLog : l)
                        .sort((a,b) => new Date(b.date) - new Date(a.date));

                    return { ...p, timeSpent: p.timeSpent + timeDifference, logs: updatedLogs };
                }));

            } else { // --- ADDING NEW LOG ---
                const now = new Date();
                const timePart = now.toTimeString().split(' ')[0]; // HH:mm:ss
                const entryIsoDate = new Date(`${details.date}T${timePart}`).toISOString();

                const newLog = {
                    id: now.getTime(),
                    date: entryIsoDate,
                    method: 'manual',
                    duration: Math.round(details.seconds),
                    manualType: details.type,
                    manualRange: details.type === 'range' ? { start: details.start, end: details.end } : undefined,
                };
                
                setProjects(prev => prev.map(p =>
                    p.id === projectForTimeEntry ? { 
                        ...p, 
                        timeSpent: p.timeSpent + Math.round(details.seconds),
                        logs: [newLog, ...(p.logs || [])].sort((a,b) => new Date(b.date) - new Date(a.date))
                    } : p
                ));
            }

            handleCloseTimeEntryModal();
        };

        const handleDeleteLogRequest = (projectId, logId) => {
            setLogToDelete({ projectId, logId });
            setIsConfirmLogDeleteModalOpen(true);
        };

        const handleConfirmLogDelete = () => {
            if (!logToDelete) return;

            setProjects(prev => prev.map(p => {
                if (p.id !== logToDelete.projectId) return p;
                
                const logToDeleteDetails = p.logs.find(l => l.id === logToDelete.logId);
                if (!logToDeleteDetails) return p;
                
                const newTimeSpent = p.timeSpent - logToDeleteDetails.duration;
                const newLogs = p.logs.filter(l => l.id !== logToDelete.logId);
                
                return { ...p, timeSpent: newTimeSpent, logs: newLogs };
            }));
            
            setLogToDelete(null);
            setIsConfirmLogDeleteModalOpen(false);
        };
        
        const handleCancelLogDelete = () => {
            setLogToDelete(null);
            setIsConfirmLogDeleteModalOpen(false);
        };
        
        const handleColorChange = (projectId, newColor) => {
            setProjects(prev => prev.map(p =>
                p.id === projectId ? { ...p, color: newColor } : p
            ));
        };

        const toggleProjectExpansion = (id) => {
            setProjects(prev => prev.map(p => 
                p.id === id ? { ...p, isExpanded: !p.isExpanded } : p
            ));
        };
        
        const handleSort = (sortBy) => {
            setSortOrder(sortBy);
            setProjects(prevProjects => {
                const projectsCopy = [...prevProjects];
        
                if (sortBy === 'lastInteraction') {
                    const getLastInteraction = (project) => {
                        if (project.timerStartTime) {
                            return project.timerStartTime;
                        }
                        if (project.logs && project.logs.length > 0) {
                            // Logs are pre-sorted, so the first one is the most recent
                            return new Date(project.logs[0].date).getTime();
                        }
                        return new Date(project.createdAt).getTime();
                    };
                    
                    projectsCopy.sort((a, b) => getLastInteraction(b) - getLastInteraction(a));
                } else { // 'lastAdded'
                    projectsCopy.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                }
                
                return projectsCopy;
            });
        };
        
        const handleSearch = (filter) => {
            setSearchFilter(filter);
            setIsSearchModalOpen(false);
        };

        const handleClearSearch = () => {
            setSearchFilter(null);
        };

        const displayedProjects = useMemo(() => {
            if (!searchFilter) {
                return projects;
            }

            return projects.filter(p => {
                if (searchFilter.type === 'name') {
                    return p.name.toLowerCase().includes(searchFilter.value.toLowerCase());
                }
                if (searchFilter.type === 'date') {
                    const start = new Date(searchFilter.value.start);
                    start.setHours(0, 0, 0, 0); // Start of the day
                    const end = new Date(searchFilter.value.end);
                    end.setHours(23, 59, 59, 999); // End of the day
                    
                    const projectDate = new Date(p.createdAt);
                    return projectDate >= start && projectDate <= end;
                }
                return true;
            });
        }, [projects, searchFilter]);

        const projectToDeleteDetails = projects.find(p => p.id === projectToDelete);
        const projectForModal = projects.find(p => p.id === projectForTimeEntry);
        const logForModal = projectForModal && logToEdit ? projectForModal.logs.find(l => l.id === logToEdit.logId) : null;
        const logToDeleteDetails = logToDelete ? projects.find(p => p.id === logToDelete.projectId)?.logs.find(l => l.id === logToDelete.logId) : null;


        return (
            <>
                <header className="header">
                    <div className="header-controls-left">
                        <button className="view-toggle-button" onClick={() => setIsCompactView(v => !v)}>
                           {isCompactView ? 'Show More' : 'Show Less'}
                        </button>
                        <div className="header-search">
                            <button className="search-header-button" onClick={() => setIsSearchModalOpen(true)}>
                               Search
                            </button>
                            {searchFilter && (
                                <button className="clear-search-button" onClick={handleClearSearch}>
                                   Clear Search
                                </button>
                            )}
                        </div>
                    </div>
                     <div className="header-controls-center">
                        <div className="global-color-picker">
                            <div className="color-picker-display" style={{ backgroundColor: accentColor }}></div>
                            <input 
                                type="color" 
                                className="color-picker-input" 
                                value={accentColor}
                                onChange={(e) => setAccentColor(e.target.value)}
                                aria-label="Change theme accent color"
                            />
                        </div>
                    </div>
                    <div className="header-actions">
                        <div className="header-actions-row">
                            <button className="add-project-header-button" onClick={handleOpenAddProjectModal}>
                               Add Project
                            </button>
                            <button className={`save-button ${saveState}`} onClick={handleSave}>
                               {saveState === 'saved' ? 'Saved!' : 'Save'}
                            </button>
                        </div>
                        <div className="header-actions-row">
                            <span className="sort-by-label">Sort by:</span>
                            <button 
                                className={`sort-button ${sortOrder === 'lastAdded' ? 'active' : ''}`}
                                onClick={() => handleSort('lastAdded')}
                                disabled={projects.length === 0}
                                aria-label="Sort by last added"
                            >
                                Last Added
                            </button>
                            <button 
                                className={`sort-button ${sortOrder === 'lastInteraction' ? 'active' : ''}`}
                                onClick={() => handleSort('lastInteraction')}
                                disabled={projects.length === 0}
                                aria-label="Sort by last active"
                            >
                                Last Active
                            </button>
                        </div>
                    </div>
                </header>

                <main>
                    {displayedProjects.length > 0 ? (
                        <ul className="project-list">
                            {displayedProjects.map(project => (
                                <ProjectItem
                                    key={project.id}
                                    project={project}
                                    isCompactView={isCompactView}
                                    onToggleTimer={handleToggleTimer}
                                    onEditProject={handleOpenEditProjectModal}
                                    onDeleteProject={handleDeleteRequest}
                                    onOpenAddTime={handleOpenAddTimeModal}
                                    onToggleExpansion={toggleProjectExpansion}
                                    onEditLog={handleOpenEditLogModal}
                                    onDeleteLog={handleDeleteLogRequest}
                                    onColorChange={handleColorChange}
                                />
                            ))}
                        </ul>
                    ) : (
                         <div className="no-projects">
                            {searchFilter ? (
                                <p>No projects match your search criteria.</p>
                             ) : (
                                <>
                                <p>No projects yet.</p>
                                <p>Click 'Add Project' above to get started.</p>
                                </>
                             )}
                        </div>
                    )}
                </main>

                {isProjectModalOpen && <ProjectModal projectToEdit={projectToEdit} onSave={handleSaveProject} onClose={handleCloseProjectModal} />}
                
                {isSearchModalOpen && <SearchModal onSearch={handleSearch} onClose={() => setIsSearchModalOpen(false)} />}
                
                {isConfirmDeleteModalOpen && projectToDeleteDetails && (
                    <ConfirmationModal 
                        message={`Are you sure you want to delete "${projectToDeleteDetails.name}"? This action cannot be undone.`}
                        onConfirm={handleConfirmDelete}
                        onCancel={handleCancelDelete}
                    />
                )}

                {isTimeEntryModalOpen && projectForModal && (
                    <TimeEntryModal 
                        project={projectForModal}
                        logToEdit={logForModal}
                        onSubmit={handleSaveTimeEntry}
                        onClose={handleCloseTimeEntryModal}
                    />
                )}

                {isConfirmLogDeleteModalOpen && logToDeleteDetails && (
                    <ConfirmationModal
                        message={`Are you sure you want to delete the time entry for ${formatLogDate(logToDeleteDetails.date)} of ${formatTime(logToDeleteDetails.duration)}?`}
                        onConfirm={handleConfirmLogDelete}
                        onCancel={handleCancelLogDelete}
                    />
                )}
            </>
        );
    };

    const container = document.getElementById('root');
    if(container) {
        const root = createRoot(container);
        root.render(<App />);
    }
  </script>
</body>
</html>
